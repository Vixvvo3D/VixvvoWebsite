<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Printing Cost Calculator</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    :root {
      --primary-color: #222126;
      --secondary-color: #444;
      --accent-color: #e9c46a;
      --bg-color: #f4f4f9;
      --text-color: #333;
      --radius: 8px;
      --spacing: 16px;
      --tab-bg: #eee;
      --tab-active: #ddd;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      padding: var(--spacing);
    }
    .container {
      width: 100%;
      max-width: 900px;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    header {
      background: var(--primary-color);
      color: #fff;
      padding: var(--spacing);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 1.8rem; }
    #login-button {
      background: var(--accent-color);
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-size: 1rem;
      cursor: pointer;
    }
    nav { display: flex; background: var(--tab-bg); }
    nav button {
      flex: 1;
      padding: var(--spacing);
      background: var(--tab-bg);
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    nav button.active { background: var(--tab-active); font-weight: bold; }
    .tab-content { display: none; padding: var(--spacing); }
    .tab-content.active { display: block; }
    fieldset {
      border: 1px solid #ddd;
      border-radius: var(--radius);
      padding: var(--spacing);
      background: #fafafa;
      margin-bottom: var(--spacing);
    }
    fieldset legend {
      padding: 0 var(--spacing);
      font-weight: bold;
      color: var(--primary-color);
    }
    label { display: block; margin-bottom: 4px; font-size: 0.9rem; }
    select, input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      font-size: 0.9rem;
      margin-bottom: var(--spacing);
    }
    table { width: 100%; border-collapse: collapse; margin-bottom: var(--spacing); }
    table th, table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button.primary {
      padding: var(--spacing);
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.3s;
      margin-top: var(--spacing);
      width: 100%;
    }
    button.primary:hover { background: var(--accent-color); }
    .results p { margin: 8px 0; font-size: 0.95rem; }

    /* Login Modal */
    #modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; z-index: 999;
    }
    #login-modal {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff; padding: 24px; border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.3); display: none; z-index: 1000;
    }
    #login-modal h3 { margin-top: 0; color: var(--primary-color); }
    #login-modal input {
      width: 100%; padding: 8px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: var(--radius);
    }
    @media (max-width: 600px) {
  .container {
    width: 95%;
    margin-top: 20px;
  }
  nav button {
    font-size: 0.9rem;
    padding: 12px;
  }
}

  </style>
</head>

<body>
  <div id="modal-overlay"></div>
  <div id="loading-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10000; font-size:1.5rem; background:rgba(0,0,0,0.7); color:white; padding:20px 30px; border-radius:8px;">
    Loading...
  </div>

<!-- LOGOUT MODAL OUTSIDE -->
<div id="logout-modal" style="display:none;">
  <div style="background:#fff; padding:24px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1001;">
    <h3 style="margin-top:0; color:#222126;">Confirm Logout</h3>
    <p>Are you sure you want to logout?</p>
    <div style="margin-top:20px; display:flex; justify-content:space-between;">
      <button id="confirm-logout" class="primary" style="width:45%;">Yes</button>
      <button id="cancel-logout" class="primary" style="background:#ccc; color:#000; width:45%;">No</button>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="login-modal">
  <h3>Login</h3>
  <input type="email" id="login-email" placeholder="Email" required>
  <input type="password" id="login-password" placeholder="Password" required>
  <p id="login-error" style="color:red; font-size:0.9rem; margin:8px 0;"></p>
  <button id="submit-login" class="primary">Submit</button>
</div>


  <div class="container">
    <header>
      <h1>3D Printing Cost Calculator</h1>
      <button id="login-button">Login</button>
    </header>

    <nav>
      <button class="tab-button active" data-tab="calculator-tab">Calculator</button>
      <button class="tab-button" data-tab="printers-tab">Printers</button>
      <button class="tab-button" data-tab="filaments-tab">Filaments</button>
    </nav>

    <!-- Calculator Tab -->
    <div id="calculator-tab" class="tab-content active">
      <form id="calculator-form">
        <fieldset>
          <legend>Printer & Filament</legend>
          <label for="printer-select">Printer Type</label>
          <select id="printer-select"></select>
          <label for="filament-select">Filament Type</label>
          <select id="filament-select"></select>
        </fieldset>
        <fieldset>
          <legend>Print Parameters</legend>
          <label>Print Time (hrs)</label><input type="number" id="print-time" step="0.01" value="0">
          <label>Weight (g)</label><input type="number" id="weight" step="0.1" value="0">
        </fieldset>
        <fieldset>
            <legend>Costs</legend>
            <label>Time to Print (h)</label>
            <input type="number" id="print-time-duplicate" step="0.01" readonly style="background:#eee;">
            
            <label>Electricity Cost ($/kWh)</label>
            <input type="number" id="electricity-cost" value="0.12" step="0.01">
          </fieldset>
        <fieldset>
          <legend>Post-Processing (min)</legend>
          <label>Job Removal</label><input type="number" id="job-removal" value="0" step="0.1">
          <label>Support Removal</label><input type="number" id="support-removal" value="0" step="0.1">
          <label>Additional Work</label><input type="number" id="additional-work" value="0" step="0.1">
        </fieldset>
        <fieldset>
          <legend>Preparation (min)</legend>
          <label>Model Prep</label><input type="number" id="model-prep" value="0" step="0.1">
          <label>Slicing</label><input type="number" id="slicing" value="0" step="0.1">
          <label>Material Change</label><input type="number" id="material-change" value="0" step="0.1">
          <label>Transfer & Start</label><input type="number" id="transfer-start" value="0" step="0.1">
        </fieldset>
        <fieldset>
          <legend>Markups & Failures</legend>
          <label>Filament Markup (×)</label><input type="number" id="filament-markup" value="2.7" step="0.1">
          <label>General Markup (%)</label><input type="number" id="general-markup" value="50" step="1">
          <label>Failure Rate (%)</label><input type="number" id="failure-rate" value="10" step="1">
        </fieldset>
        <button type="button" id="calculate-button" class="primary">Calculate</button>
      </form>
      <div id="results" class="results"></div>
    </div>

    <!-- Printers Tab -->
    <div id="printers-tab" class="tab-content">
      <h2>Manage Printers</h2>
      <table>
        <thead><tr><th>Name</th><th>Cost$/hr</th><th>Actions</th></tr></thead>
        <tbody id="printer-table"></tbody>
      </table>
      <form id="add-printer-form">
        <fieldset><legend>Add Printer</legend>
          <label>Name</label><input type="text" id="new-printer-name" required>
          <label>Cost per hour ($)</label><input type="number" id="new-printer-cost" step="0.001" required>
          <button type="submit" class="primary">Add Printer</button>
        </fieldset>
      </form>
    </div>

    <!-- Filaments Tab -->
    <div id="filaments-tab" class="tab-content">
      <h2>Manage Filaments</h2>
      <table>
        <thead><tr><th>Type</th><th>Brand</th><th>Cost$/kg</th><th>Actions</th></tr></thead>
        <tbody id="filament-table"></tbody>
      </table>
      <form id="add-filament-form">
        <fieldset><legend>Add Filament</legend>
          <label>Brand</label>
<select id="new-filament-brand" required>
  <option value="">Select a brand</option>
  <option value="ELEGOO">Elegoo</option>
  <option value="Polymaker">Polymaker</option>
  <option value="Prusa">Prusa</option>
  <option value="Esun">Esun</option>
  <option value="Sunlu">Sunlu</option>
  <option value="Bambu Lab">Bambu Lab</option>
  <option value="Creality">Creality</option>
  <option value="Anycubic">Anycubic</option>
  <option value="Eryone">Eryone</option>
  <option value="Kingroon">Kingroon</option>
  <option value="Hatchbox">Hatchbox</option>
  <option value="Overture">Overture</option>
</select>
<label>Type</label>
<select id="new-filament-type" required>
  <option value="">Select a brand first</option>
</select>

          

          <label>Cost per spool ($)</label>
<input type="number" id="new-filament-cost" step="0.01" required>
          <button type="submit" class="primary">Add Filament</button>
        </fieldset>
      </form>
    </div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDwEDp5SfrxeEntOJg_XzbiBoGc9ADbX5g",
      authDomain: "vixvvowebsite.firebaseapp.com",
      projectId: "vixvvowebsite",
      storageBucket: "vixvvowebsite.appspot.com",
      messagingSenderId: "862620702799",
      appId: "1:862620702799:web:d06c0ec4e7b0f3010d323a",
      measurementId: "G-VX36JF6PTT",
      databaseURL: "https://vixvvowebsite-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
  const btn = document.getElementById('login-button');

  if (user) {
  // User is signed in → show “Logout”
  btn.textContent = 'Logout';
  btn.disabled = false;
  btn.onclick = () => {
    document.getElementById('login-modal').style.display = 'none';  // 🛠
    document.getElementById('logout-modal').style.display = 'block';
    document.getElementById('modal-overlay').style.display = 'block';
  };

    document.getElementById('add-printer-form').style.display = 'block';
    document.getElementById('add-filament-form').style.display = 'block';
  } else {
    btn.textContent = 'Login';
    btn.disabled = false;
    btn.onclick = () => {
      document.getElementById('login-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
    };
    document.getElementById('add-printer-form').style.display = 'none';
    document.getElementById('add-filament-form').style.display = 'none';
  }

  printersRef.once('value', snap => populatePrintersList(Object.values(snap.val() || {})));
  filamentsRef.once('value', snap => populateFilamentsList(Object.values(snap.val() || {})));
  // Show and hide spinner
function showSpinner() {
  document.getElementById('loading-spinner').style.display = 'block';
}
function hideSpinner() {
  document.getElementById('loading-spinner').style.display = 'none';
}

});

// Logout modal button actions
document.getElementById('confirm-logout').addEventListener('click', () => {
  firebase.auth().signOut();
  document.getElementById('logout-modal').style.display = 'none';
  document.getElementById('modal-overlay').style.display = 'none';
});

document.getElementById('cancel-logout').addEventListener('click', () => {
  document.getElementById('logout-modal').style.display = 'none';
  document.getElementById('modal-overlay').style.display = 'none';
});
// 🛠 LOGIN BUTTON ACTION (Missing!)
document.getElementById('submit-login').addEventListener('click', () => {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(() => {
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
      document.getElementById('login-error').textContent = '';
    })
    .catch(error => {
      document.getElementById('login-error').textContent = 'Wrong email or password.';
    });
});



const printersRef = db.ref('printers');
const filamentsRef = db.ref('filaments');
const $ = id => document.getElementById(id);

// 🛠️ ADD THIS RIGHT AFTER
const brandTypes = {
  "Bambu Lab": ["PLA Basic", "PLA Matte", "PETG Basic", "PETG Matte", "ABS Basic", "ASA Basic", "PC", "PA", "PA-CF", "PVA"],
  "ELEGOO": ["PLA", "ABS", "PETG"],
  "Polymaker": ["PolyLite PLA", "PolyMax PLA", "PolyTerra PLA", "PolyLite PETG", "PolyMax PETG", "PolyLite ABS"],
  "Prusa": ["Prusament PLA", "Prusament PETG", "Prusament ASA"],
  "Esun": ["PLA+", "PETG", "ABS+", "TPU", "eSilk-PLA"],
  "Sunlu": ["PLA", "PETG", "ABS", "TPU"],
  "Creality": ["Ender PLA", "Ender PETG", "Ender ABS"],
  "Anycubic": ["PLA", "PETG", "ABS", "TPU"],
  "Eryone": ["PLA", "PETG", "TPU"],
  "Kingroon": ["PLA", "PETG"],
  "Hatchbox": ["PLA", "ABS", "PETG", "Wood PLA"],
  "Overture": ["PLA", "PETG", "TPU", "ABS"]
};

document.getElementById('new-filament-brand').addEventListener('change', function() {
  const brand = this.value;
  const typeSelect = document.getElementById('new-filament-type');
  typeSelect.innerHTML = ''; // Clear previous options

  if (brand && brandTypes[brand]) {
    brandTypes[brand].forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      typeSelect.appendChild(option);
    });
  } else {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Select a brand first';
    typeSelect.appendChild(option);
  }
});


    // Tabs
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      $(tabId).classList.add('active');
      document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
    }
    document.querySelectorAll('.tab-button')
      .forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));

    // Populate lists
    printersRef.on('value', snap => populatePrintersList(Object.values(snap.val() || {})));
    filamentsRef.on('value', snap => populateFilamentsList(Object.values(snap.val() || {})));

    $('print-time').addEventListener('input', () => {
  $('print-time-duplicate').value = $('print-time').value;
});

    function populatePrintersList(printers) {
  const tbody = $('printer-table');
  const select = $('printer-select');
  tbody.innerHTML = '';
  select.innerHTML = '';
  const isAdmin = !!auth.currentUser;        // ← add this line

  printers.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>$${p.costPerHour.toFixed(3)}</td>
      ${isAdmin
        ? `<td><button onclick="deletePrinter('${p.name}')">Delete</button></td>`
        : `<td></td>`
      }
    `;
    tbody.appendChild(tr);
    select.append(new Option(`${p.name} ($${p.costPerHour.toFixed(3)}/h)`, p.name));
  });
}
function populateFilamentsList(filaments) {
  const tbody = $('filament-table');
  const select = $('filament-select');
  tbody.innerHTML = '';
  select.innerHTML = '';
  const isAdmin = !!auth.currentUser;     // ← add this line

  filaments.forEach(f => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${f.type}</td>
      <td>${f.brand}</td>
      <td>$${(f.costPerG*1000).toFixed(2)}</td>
      ${isAdmin
        ? `<td><button onclick="deleteFilament('${f.type}')">Delete</button></td>`
        : `<td></td>`
      }
    `;
    tbody.appendChild(tr);
    select.append(new Option(
      `${f.type} (${f.brand}) ($${(f.costPerG*1000).toFixed(2)}/kg)`,
      f.type
    ));
  });
}

    // Add / delete
    $('add-printer-form').addEventListener('submit', e => {
      e.preventDefault();
      const name = $('new-printer-name').value;
      const costPerHour = parseFloat($('new-printer-cost').value);
      printersRef.push({ name, costPerHour });
      e.target.reset();
    });
    $('add-filament-form').addEventListener('submit', e => {
      e.preventDefault();
      const type = $('new-filament-type').value;
      const brand = $('new-filament-brand').value;
      const spoolCost = parseFloat($('new-filament-cost').value);
const costPerG = spoolCost / 1000; // ← convert spool price into price per gram
filamentsRef.push({ type, brand, costPerG });
      e.target.reset();
    });
    function deletePrinter(name) {
      printersRef.orderByChild('name').equalTo(name).once('value', snap => {
        snap.forEach(child => child.ref.remove());
      });
    }
    function deleteFilament(type) {
      filamentsRef.orderByChild('type').equalTo(type).once('value', snap => {
        snap.forEach(child => child.ref.remove());
      });
    }

    // Calculation
    $('calculate-button').addEventListener('click', calculate);
    function calculate() {
  const printerName = $('printer-select').value;
  const filamentType = $('filament-select').value;

  printersRef.orderByChild('name').equalTo(printerName).once('value', snap => {
    if (!snap.val()) return alert("Printer not found.");
    const p = Object.values(snap.val())[0];

    filamentsRef.orderByChild('type').equalTo(filamentType).once('value', snap2 => {
      if (!snap2.val()) return alert("Filament not found.");
      const f = Object.values(snap2.val())[0];

      // Inputs
      const pt = +$('print-time').value; // Print Time in hours
      const w  = +$('weight').value / 1000; // Weight in kilograms
      const electricityPrice = +$('electricity-cost').value; // $/kWh
      const electricityUsagePerHour = 0.1; // typical printer usage (kWh/h)
      const costElectric = pt * electricityUsagePerHour * electricityPrice;

      const jr = +$('job-removal').value / 60; // mins to hours
      const sr = +$('support-removal').value / 60;
      const aw = +$('additional-work').value / 60;
      const mp = +$('model-prep').value / 60;
      const sl = +$('slicing').value / 60;
      const mc = +$('material-change').value / 60;
      const ts = +$('transfer-start').value / 60;

      const fm = +$('filament-markup').value;
      const gm = +$('general-markup').value / 100;
      const fr = +$('failure-rate').value / 100;

      // Cost Calculations

      // Printer Depreciation
      const costPrinter = p.costPerHour * pt;

      // Filament
      const costFilament = f.costPerG * 1000 * w * fm; // multiplied by filament markup

      // Subtotal
      const subtotal = costPrinter + costFilament + costElectric;

      // Add markup
      const subtotalWithMarkup = subtotal * (1 + gm);

      // Add failure rate
      const finalPrice = subtotalWithMarkup / (1 - fr);

      // Display
      const r = $('results');
      r.innerHTML = `
        <p>Printer Depreciation: $${costPrinter.toFixed(2)}</p>
        <p>Filament: $${costFilament.toFixed(2)}</p>
        <p>Electricity: $${costElectric.toFixed(2)}</p>
        <hr>
        <p>Subtotal (before markup): $${subtotal.toFixed(2)}</p>
        <p>+ General Markup (${(gm * 100).toFixed(0)}%)</p>
        <p>+ Failure Rate (${(fr * 100).toFixed(0)}%)</p>
        <hr>
        <p><strong>Total Price: $${finalPrice.toFixed(2)}</strong></p>
      `;
    });
  });
}
  </script>
</body>
</html>